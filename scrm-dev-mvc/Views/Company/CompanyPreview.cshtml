@model scrm_dev_mvc.Models.ViewModels.CompanyPreviewViewModel

<style>
    .nav-box.active {
        background: var(--bg-tertiary, #f2f4f8);
        color: var(--color-primary, #2b2d42);
        font-weight: bold;
        border-bottom: 2px solid var(--color-primary, #2b2d42);
        border-radius: var(--border-radius-sm, 6px) 6px 0 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
</style>

<div style="padding: 0 0 0 var(--space-md);">
    <a href="@Url.Action("Index", "Company")" style="
        display: inline-block;
        color: var(--color-primary);
        font-size: var(--fs-sm);
        font-family: var(--font-primary);
        font-weight: var(--fw-bold);
        text-decoration: none;
        letter-spacing: 0.03em;
        transition: var(--transition-base);
        border-radius: var(--border-radius-sm);
    "
       onmouseover="this.style.backgroundColor=window.getComputedStyle(document.body).getPropertyValue('--bg-secondary')"
       onmouseout="this.style.backgroundColor='transparent'">
        &lt; Companies
    </a>
</div>

<!-- Add Contact Modal -->
<div id="contactModal" class.modal" tabindex="-1"
     style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 400px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header">
                <h5 class="modal-title">Select a Contact</h5>
                <button type="button" class="btn-close" onclick="closeContactModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 350px; overflow-y: auto;">
                <ul id="contactList" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid" style="max-width: var(--container-width); margin: var(--space-xl) auto;">
    <div class="row" style="display: flex; gap: var(--space-lg);">

        <!-- Column 1: Company Profile -->
        <aside style="flex: 1; min-width: 280px;">
            <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); padding: var(--space-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--space-lg); text-align: left;">
                <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                    <span class="rounded-circle" style="display:inline-block;width:80px;height:80px;background:var(--color-accent2);color:var(--color-secondary);text-align:center;line-height:80px; font-size: 2.5rem;">
                        <i class="fas fa-building"></i>
                    </span>
                    <h2 style="font-size: var(--fs-h3); margin: 0;">@Model.Name</h2>
                </div>
                <p style="color: var(--color-accent1); margin-bottom: var(--space-sm);">@Model.Domain</p>
                <p style="color: var(--text-secondary);">@Model.Domain</p>
                <p style="color: var(--text-secondary);">Location: @Model.City, @Model.Country</p>
            </section>
            <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); padding: var(--space-lg);">
                <h3 style="font-size: var(--fs-lg); color: var(--color-accent1); margin-bottom: var(--space-md);">About this company</h3>
                <div style="font-size:var(--fs-base);color:var(--text-secondary);">
                    <div><b>Domain:</b> @Model.Domain</div>
                    <div><b>Created At:</b> @Model.CreatedAt?.ToString("MM/dd/yyyy hh:mm tt")</div>
                </div>
            </section>
        </aside>

        <!-- Column 2: Tabs and Overview/Activities -->
        <main style="flex: 2; min-width: 520px;">
            <nav class="nav-tabs" style="display:flex; gap:var(--space-md); border-bottom:1px solid var(--border-color); margin-bottom: var(--space-lg);">
                <button type="button" class="nav-box active" id="tab-overview" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('overview')">Overview</button>
                <button type="button" class="nav-box" id="tab-activities" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('activities')">Activities</button>
            </nav>

            <!-- Overview Tab -->
            <section id="tab-content-overview" class="tab-content" style="display:block;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Company Highlights</h3>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-lg);color:var(--text-secondary);">
                        <div>
                            <b>Create Date:</b><br />@Model.CreatedAt?.ToString("MM/dd/yyyy hh:mm tt")
                        </div>
                        <div>
                            <b>Domain:</b><br />@Model.Domain
                        </div>
                        <div>
                            <b>Location:</b><br />@Model.City, @Model.Country
                        </div>
                    </div>
                </div>
            </section>

            <!-- --- UPDATED ACTIVITIES TAB --- -->
            <section id="tab-content-activities" class="tab-content" style="display:none;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Recent Activities</h3>
                    @if (Model.Activities != null && Model.Activities.Any())
                    {
                        <ul style="list-style:none;padding:0;margin:0; max-height: 300px; overflow-y: auto;">
                            @foreach (var act in Model.Activities.OrderByDescending(a => a.ActivityDate))
                            {
                                // Set default icon and name in case ActivityType is null
                                var activityName = act.ActivityType?.Name ?? "Activity";
                                var icon = "tasks"; // Default icon
                                if (activityName.Equals("Email", StringComparison.OrdinalIgnoreCase))
                                {
                                    icon = "envelope";
                                }
                                else if (activityName.Equals("Call", StringComparison.OrdinalIgnoreCase))
                                {
                                    icon = "phone";
                                }

                                <li style="border-bottom:1px solid var(--border-color); padding:var(--space-md) 0; display:flex; gap: var(--space-md); align-items: flex-start;">

                                    <!-- Icon -->
                                    <div style="font-size: 1.25rem; color: var(--color-primary); margin-top: 3px;">
                                        <i class="fas fa-@icon"></i>
                                    </div>

                                    <!-- Activity Details -->
                                    <div style="flex-grow: 1;">

                                        <!-- Header: Activity Type & Date -->
                                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                            <h6 style="font-weight:var(--fw-bold); color: var(--color-accent1); margin: 0;">
                                                @activityName
                                                <!-- NEW: Show Owner -->
                                                <span style="color:var(--text-secondary); font-weight: 500; font-size: 0.9em;">
                                                    by @(act.Owner?.Email ?? "Unknown")
                                                </span>
                                            </h6>
                                            <span style="color:var(--text-secondary); font-size: var(--fs-sm);">
                                                @act.ActivityDate?.ToString("dd MMM yyyy")
                                            </span>
                                        </div>

                                        <!-- Notes -->
                                        <div style="color:var(--text-secondary); font-size: 0.95rem;">
                                            @act.Notes
                                        </div>

                                        <!-- Status (if it's a task with a due date) -->
                                        @if (act.ActivityType?.Name == "Task" && act.DueDate.HasValue)
                                        {
                                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                                <span style="font-weight: 500;">Due: @act.DueDate.Value.ToString("dd MMM yyyy")</span>
                                                - <span style="color: var(--color-accent);">Status: @act.Status</span>
                                            </div>
                                        }

                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p style="color:var(--text-tertiary);">No recent activities for this company's contacts.</p>
                    }
                </div>
            </section>
            <!-- --- END UPDATED SECTION --- -->

        </main>
    </div>
    <!-- Separate rows for Contacts and Deals, similar to ContactPreview -->
    <div class="row" style="display: flex; gap: var(--space-lg); margin-top: var(--space-lg);">
        <!-- Contacts Section -->
        <section style="flex:1; background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Contacts</h3>
                <a href="@Url.Action("Create", "Contact", new { companyId = Model.Id })" class="btn btn-custom" style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);">+ Add Contact</a>
            </div>
            @if (Model.Contacts != null && Model.Contacts.Any())
            {
                <ul style="list-style:none;padding:0;">
                    @foreach (var contact in Model.Contacts)
                    {
                        <li style="border-bottom:1px solid var(--border-color);padding:var(--space-md) 0;">
                            <a href="@Url.Action("Preview", "Contact", new { id = contact.Id })" style="font-weight:var(--fw-bold); text-decoration: none; color: var(--color-accent1);">
                                <span style="margin-right:var(--space-sm);"><i class="fas fa-user"></i></span>
                                @contact.FirstName @contact.LastName
                            </a>
                            <div style="color:var(--text-secondary); font-size: 0.9rem; padding-left: 28px;">@contact.JobTitle</div>
                            <div style="color:var(--text-secondary); font-size: 0.9rem; padding-left: 28px;">@contact.Email</div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p style="color:var(--text-tertiary);">No contacts associated.</p>
            }
        </section>
        <!-- Deals Section -->
        <section style="flex:1; background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Deals</h3>
                <a href="@Url.Action("Create", "Deal", new { companyId = Model.Id })" class="btn btn-custom" style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);">+ Add Deal</a>
            </div>
            @if (Model.Deals != null && Model.Deals.Any())
            {
                <ul style="list-style:none;padding:0;">
                    @foreach (var deal in Model.Deals)
                    {
                        <li style="border-bottom:1px solid var(--border-color);padding:var(--space-md) 0;">
                            <a href="@Url.Action("Details", "Deal", new { id = deal.Id })" style="font-weight:var(--fw-bold); text-decoration: none; color: var(--color-accent1);">
                                <span style="margin-right:var(--space-sm);"><i class="fas fa-dollar-sign"></i></span>
                                @deal.Name
                            </a>
                            <div style="color:var(--text-secondary); font-size: 0.9rem; padding-left: 28px;">@deal.Value?.ToString("C0")</div>
                            <div style="color:var(--text-secondary); font-size: 0.9rem; padding-left: 28px;">Stage: @deal.Stage?.Name</div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p style="color:var(--text-tertiary);">No deals associated.</p>
            }
        </section>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
@Html.AntiForgeryToken() @* Add token for AJAX POST *@

<script>
    function showTab(tabName) {
        document.getElementById('tab-content-overview').style.display = 'none';
        document.getElementById('tab-content-activities').style.display = 'none';

        document.getElementById('tab-' + tabName).classList.add('active');
        ['overview', 'activities'].forEach(function(tab) {
            if (tab !== tabName) document.getElementById('tab-' + tab).classList.remove('active');
        });
        document.getElementById('tab-content-' + tabName).style.display = 'block';
    }

    // Modal logic for selecting a contact to add to the company
    // This button/modal doesn't seem to be in this view, but leaving the functions
    // in case you add an "Associate Contact" button.
    function openContactModal() {
        $.get('@Url.Action("GetAll", "Contact")', function(response) {
            var list = $('#contactList');
            list.empty();
            (response.data || []).forEach(function(contact) {
                var contactId = contact.id;
                var contactName = contact.name || `${contact.firstName || ''} ${contact.lastName || ''}`;
                var contactEmail = contact.email;

                list.append(
                    `<li style="padding:8px; border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="selectContact(${contactId})">
                        <b>${contactName.trim() || 'Unnamed Contact'}</b>
                        <span style="color:var(--text-secondary); font-size:var(--fs-sm);">${contactEmail ?? ''}</span>
                    </li>`
                );
            });
            $('#contactModal').css('display', 'flex');
        });
    }
    function closeContactModal() {
        $('#contactModal').hide();
    }
    function selectContact(contactId) {
        var token = $('input[name="__RequestVerificationToken"]').val();
        $.ajax({
            url: '/Contact/AssociateContactToCompany', // This associates a contact *to* this company
            type: 'POST',
            data: {
                contactId: contactId,
                companyId: '@Model.Id'
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function() {
                closeContactModal();
                location.reload();
            },
            error: function(xhr) {
                 alert("Failed to associate contact: " + (xhr.responseJSON?.message || xhr.responseText));
            }
        });
    }
</script>
