@model scrm_dev_mvc.Models.ViewModels.KanbanBoardViewModel
@Html.AntiForgeryToken() 

<div class="kanban-container">

    <div class="kanban-header">
        @* <h2 style="font-size:1.2rem; margin:0;">Deals Board</h2> *@
        <h3 class ="text-2xl font-bold text-gray-900 py-2">
            Deals Board</h3>
        <a class="btn btn-primary btn-custom" style="padding:0.3rem 1rem;" asp-action="Create" asp-controller="Deal">
            + Create Deal
        </a>
    </div>

    <div class="kanban-board">
        @foreach (var stage in Model.DealStages)
        {
            <div class="kanban-column" data-stage-name="@stage">
                <!-- Changed to data-stage-name -->
                <div class="kanban-column-header">
                    <span class="column-title">@stage</span>
                    <!-- Added data-stage-count attribute for easy selection -->
                    <span class="column-count" data-stage-count="@stage">@Model.DealsByStage[stage].Count</span>
                </div>
                <!-- Added data-stage-body attribute -->
                <div class="kanban-column-body" data-stage-body="@stage">
                    @foreach (var deal in Model.DealsByStage[stage])
                    {
                        <!-- Added data-value attribute -->
                        <div class="kanban-card" data-deal-id="@deal.Id" data-value="@(deal.Value ?? 0)" draggable="true">
                            <div class="deal-title">@deal.Name</div>
                            <div class="deal-info">
                                <span class="deal-value">@deal.Value?.ToString("C0")</span>
                                <span class="deal-owner">@deal.Owner?.FirstName</span>
                            </div>
                            <div class="deal-actions">
                                <a href="@Url.Action("Details", "Deal", new { id = deal.Id })" class="btn btn-sm btn-custom">View</a>
                            </div>
                        </div>
                    }
                </div>
                <!-- NEW: Column Footer for Total -->
                <div class="kanban-column-footer">
                    <strong>Total:</strong>
                    <!-- Added data-stage-total attribute -->
                    <span class="column-total-value" data-stage-total="@stage">
                        @Model.StageTotals[stage].ToString("C0")
                    </span>
                </div>
            </div>
        }
    </div>
</div>

<!-- UPDATED SCRIPT BLOCK -->
<script>
    document.addEventListener('DOMContentLoaded', (event) => {

        const cards = document.querySelectorAll('.kanban-card');
        const columns = document.querySelectorAll('.kanban-column-body');
        let draggedCard = null;
        let originalColumn = null; // --- Store the original column here

        // --- Drag Start ---
        cards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                draggedCard = this;
                originalColumn = this.closest('.kanban-column'); // --- FIX: Remember where it came from
                e.dataTransfer.setData('text/plain', this.dataset.dealId);
                setTimeout(() => {
                    this.style.opacity = '0.5';
                }, 0);
            });

            card.addEventListener('dragend', function() {
                this.style.opacity = '1';
                draggedCard = null;
                originalColumn = null; // --- FIX: Clear original column
            });
        });

        // --- Drag Over ---
        columns.forEach(col => {
            col.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
        });

        // --- Drop ---
        columns.forEach(col => {
            col.addEventListener('drop', function(e) {
                e.preventDefault();

                if (!draggedCard || !originalColumn) return; // Make sure we have both

                // Find the column element to get the stage name
                const newColumn = this.closest('.kanban-column'); // 'this' is the kanban-column-body
                const newStageName = newColumn.dataset.stageName;
                const dealId = draggedCard.dataset.dealId;

                // Get the anti-forgery token from the page
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                // --- FIX: Check if we are dropping in a new column ---
                if (dealId && newStageName && newColumn !== originalColumn) {
                    // Call the backend to update the stage
                    updateDealStageOnServer(dealId, newStageName, draggedCard, originalColumn, newColumn, token);
                } else {
                    // Dropped in the same column, do nothing.
                    console.log("Dropped in the same column.");
                }
            });
        });

        /**
         * Sends the update to the server via AJAX (fetch)
         */
        // --- FIX: Updated function signature to accept old and new column elements ---
        async function updateDealStageOnServer(dealId, newStageName, cardElement, oldColumnEl, newColumnEl, token) {

            const oldStageName = oldColumnEl.dataset.stageName; // Get name from the old column
            const newColumnBody = newColumnEl.querySelector('.kanban-column-body');

            try {
                const response = await fetch('@Url.Action("UpdateDealStage", "Deal")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        DealId: parseInt(dealId),
                        NewStageName: newStageName
                    })
                });

                if (response.ok) {
                    // Pessimistic UI: Move card only on success
                    newColumnBody.appendChild(cardElement);

                    // --- FIX: Now these functions will update the correct columns ---
                    updateColumnSummary(oldStageName); // Update the old column
                    updateColumnSummary(newStageName); // Update the new column

                    console.log(`Deal ${dealId} moved to ${newStageName}`);
                } else {
                    const error = await response.json();
                    alert(`Failed to move deal: ${error.message || 'Server error'}`);
                }
            } catch (error) {
                console.error('Error updating deal stage:', error);
                alert('An error occurred. Please refresh the page.');
            }
        }

        /**
         * --- This function is correct. It recalculates totals on the client side ---
         */
        function updateColumnSummary(stageName) {
            const column = document.querySelector(`.kanban-column[data-stage-name="${stageName}"]`);
            if (!column) return;

            const countSpan = column.querySelector('.column-count');
            const totalSpan = column.querySelector('.column-total-value');
            // Find all cards *currently* in this column's body
            const cardsInColumn = column.querySelectorAll('.kanban-column-body .kanban-card');

            // 1. Update Count
            countSpan.textContent = cardsInColumn.length;

            // 2. Update Total
            let totalValue = 0;
            cardsInColumn.forEach(card => {
                totalValue += parseFloat(card.dataset.value || 0); // Sum the values
            });

            // 3. Format and display the new total
            totalSpan.textContent = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(totalValue);
        }
    });
</script>















@* 
 @model scrm_dev_mvc.Models.ViewModels.KanbanBoardViewModel
@Html.AntiForgeryToken()

<!--
This container is now styled with Tailwind to match your Workspace page.
The `kanban-board`, `kanban-column`, `kanban-card`, and all `data-` attributes
are preserved so your JavaScript logic remains unchanged.
-->
<div class="kanban-container max-w-7xl mx-auto space-y-6 py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="kanban-header flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Deals Board</h2>
        <a class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" asp-action="Create" asp-controller="Deal">
            <i class="fas fa-plus mr-2"></i> Create Deal
        </a>
    </div>

    <!-- Board -->
    <div class="kanban-board flex space-x-6 overflow-x-auto pb-4">
        @foreach (var stage in Model.DealStages)
        {
            <!-- Column -->
            <div class="kanban-column flex flex-col w-80 bg-gray-100 rounded-lg shadow-sm border border-gray-200" data-stage-name="@stage">
                
                <!-- Column Header -->
                <div class="kanban-column-header flex justify-between items-center p-4 border-b border-gray-300">
                    <span class="column-title font-semibold text-gray-800">@stage</span>
                    <span class="column-count text-sm font-medium text-gray-600 bg-gray-200 px-2.5 py-0.5 rounded-full" data-stage-count="@stage">@Model.DealsByStage[stage].Count</span>
                </div>
                
                <!-- Column Body (Drop Zone) -->
                <div class="kanban-column-body flex-1 flex flex-col space-y-4 p-4 overflow-y-auto min-h-[150px]" data-stage-body="@stage">
                    @foreach (var deal in Model.DealsByStage[stage])
                    {
                        <!-- Card -->
                        <div class="kanban-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-grab active:cursor-grabbing" data-deal-id="@deal.Id" data-value="@(deal.Value ?? 0)" draggable="true">
                            <div class="deal-title font-semibold text-gray-900">@deal.Name</div>
                            <div class="deal-info flex justify-between items-center text-sm text-gray-500 mt-2">
                                <span class="deal-value font-medium text-green-600">@deal.Value?.ToString("C0")</span>
                                <span class="deal-owner">@deal.Owner?.FirstName</span>
                            </div>
                            <div class="deal-actions mt-4 text-right">
                                <a href="@Url.Action("Details", "Deal", new { id = deal.Id })" class="text-sm font-medium text-blue-600 hover:text-blue-800">View</a>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Column Footer -->
                <div class="kanban-column-footer flex justify-between items-center p-4 border-t border-gray-300 bg-gray-50 rounded-b-lg mt-auto">
                    <strong class="text-sm font-bold text-gray-900">Total:</strong>
                    <span class="column-total-value text-sm font-semibold text-gray-800" data-stage-total="@stage">
                        @Model.StageTotals[stage].ToString("C0")
                    </span>
                </div>
            </div>
        }
    </div>
</div>

<!-- 
==================================
NO CHANGES TO SCRIPT BLOCK
==================================
Your existing logic will work with the updated UI.
-->
<script>
    document.addEventListener('DOMContentLoaded', (event) => {

        const cards = document.querySelectorAll('.kanban-card');
        const columns = document.querySelectorAll('.kanban-column-body');
        let draggedCard = null;
        let originalColumn = null; 

        // --- Drag Start ---
        cards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                draggedCard = this;
                originalColumn = this.closest('.kanban-column'); 
                e.dataTransfer.setData('text/plain', this.dataset.dealId);
                setTimeout(() => {
                    this.style.opacity = '0.5';
                }, 0);
            });

            card.addEventListener('dragend', function() {
                this.style.opacity = '1';
                draggedCard = null;
                originalColumn = null; 
            });
        });

        // --- Drag Over ---
        columns.forEach(col => {
            col.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
        });

        // --- Drop ---
        columns.forEach(col => {
            col.addEventListener('drop', function(e) {
                e.preventDefault();

                if (!draggedCard || !originalColumn) return; 

                const newColumn = this.closest('.kanban-column'); 
                const newStageName = newColumn.dataset.stageName;
                const dealId = draggedCard.dataset.dealId;

                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                if (dealId && newStageName && newColumn !== originalColumn) {
                    updateDealStageOnServer(dealId, newStageName, draggedCard, originalColumn, newColumn, token);
                } else {
                    console.log("Dropped in the same column.");
                }
            });
        });

        /**
         * Sends the update to the server via AJAX (fetch)
         */
        async function updateDealStageOnServer(dealId, newStageName, cardElement, oldColumnEl, newColumnEl, token) {

            const oldStageName = oldColumnEl.dataset.stageName; 
            const newColumnBody = newColumnEl.querySelector('.kanban-column-body');

            try {
                const response = await fetch('@Url.Action("UpdateDealStage", "Deal")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        DealId: parseInt(dealId),
                        NewStageName: newStageName
                    })
                });

                if (response.ok) {
                    newColumnBody.appendChild(cardElement);
                    updateColumnSummary(oldStageName); 
                    updateColumnSummary(newStageName); 

                    console.log(`Deal ${dealId} moved to ${newStageName}`);
                } else {
                    const error = await response.json();
                    alert(`Failed to move deal: ${error.message || 'Server error'}`);
                }
            } catch (error) {
                console.error('Error updating deal stage:', error);
                alert('An error occurred. Please refresh the page.');
            }
        }

        /**
         * This function is correct. It recalculates totals on the client side
         */
        function updateColumnSummary(stageName) {
            const column = document.querySelector(`.kanban-column[data-stage-name="${stageName}"]`);
            if (!column) return;

            const countSpan = column.querySelector('.column-count');
            const totalSpan = column.querySelector('.column-total-value');
            const cardsInColumn = column.querySelectorAll('.kanban-column-body .kanban-card');

            // 1. Update Count
            countSpan.textContent = cardsInColumn.length;

            // 2. Update Total
            let totalValue = 0;
            cardsInColumn.forEach(card => {
                totalValue += parseFloat(card.dataset.value || 0); 
            });

            // 3. Format and display the new total
            totalSpan.textContent = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(totalValue);
        }
    });
</script> *@
