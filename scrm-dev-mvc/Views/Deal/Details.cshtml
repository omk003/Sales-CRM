@model scrm_dev_mvc.Models.ViewModels.DealPreviewViewModel

@{
    ViewData["Title"] = $"Deal: {Model.Deal.Name}";
}
<style>
    .btn-hover-shadow {
        font-size: var(--fs-sm);
        padding: var(--space-xs) var(--space-sm);
        background-color: white;
        color: black;
        /* border: thin solid #ccc; */
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: box-shadow 0.3s ease;
    }

        .btn-hover-shadow:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
</style>


<div style="padding: 0 0 0 var(--space-md);">
    <a href="@Url.Action("KanbanBoard", "Deal")" style="display: inline-block; color: var(--color-primary); font-size: var(--fs-sm); font-family: var(--font-primary); font-weight: var(--fw-bold); text-decoration: none; letter-spacing: 0.03em; transition: var(--transition-base); border-radius: var(--border-radius-sm);"
       onmouseover="this.style.backgroundColor=window.getComputedStyle(document.body).getPropertyValue('--bg-secondary')"
       onmouseout="this.style.backgroundColor='transparent'">
        &lt; Back to Deals
    </a>
</div>

<div id="contactModal" class="modal" tabindex="-1" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 400px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Select a Contact to Associate</h5>
                <button type="button" class="btn-close" onclick="closeContactModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 350px; overflow-y: auto;">
                <ul id="contactList" style="list-style:none;padding:0;margin:0;">
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="companyModal" class="modal" tabindex="-1" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 400px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Select a Company to Associate</h5>
                <button type="button" class="btn-close" onclick="closeCompanyModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 350px; overflow-y: auto;">
                <ul id="companyList" style="list-style:none;padding:0;margin:0;">
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="taskModalContainer">
</div>
<div id="taskUpdateModalContainer">
</div>


<div class="container-fluid" style="max-width: var(--container-width); margin: var(--space-xl) auto;">
    <div class="row" style="display: flex; gap: var(--space-lg);">

        <aside style="flex: 1; min-width: 280px;">
            <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); padding: var(--space-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--space-lg); text-align: center;">

                <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                    <span class="rounded-circle" style="display:inline-block;width:80px;height:80px;background:var(--color-accent2);color:var(--color-secondary);text-align:center;line-height:80px; font-size: 2.5rem;">
                        <i class="fas fa-dollar-sign"></i>
                    </span>
                    <h2 style="font-size: var(--fs-h3); margin: 0;">@Model.Deal.Name</h2>
                </div>

                <p style="color: var(--color-accent1); margin-bottom: var(--space-sm); font-size: 1.25rem; font-weight: 600;">
                    @Model.Deal.Value?.ToString("C0")
                </p>

                <p style="color: var(--text-secondary);">
                    Stage: <span style="font-weight: 600; color: var(--color-accent1);">@Model.Deal.Stage?.Name</span>
                </p>

                <div style="display:flex; justify-content:center; gap:var(--space-md); margin-bottom: var(--space-md);">
                    <a href="@Url.Action("Update", "Deal", new { id = Model.Deal.Id })" title="Edit Deal" style="color: var(--color-secondary);font-size:var(--fs);padding:var(--space-xs) var(--space-sm);">
                        <i class="fas fa-edit"></i>
                    </a>

                    <a href="javascript:void(0);"
                       title="Create Task"
                       style="color: var(--color-primary);font-size:var(--fs);padding:var(--space-xs) var(--space-sm);"
                       onclick="openCreateTaskModal(null, @Model.Deal.Id)">
                        <i class="fas fa-tasks"></i>
                    </a>
                    <a href="javascript:void(0);"
                       title="Delete Deal"
                       style="color: #dc3545; /* Danger Red */ font-size:var(--fs);padding:var(--space-xs) var(--space-sm);"
                       onclick="deleteDeal(@Model.Deal.Id)">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </div>
            </section>

            <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); padding: var(--space-lg);">
                <h3 style="font-size: var(--fs-lg); color: var(--color-accent1); margin-bottom: var(--space-md);">About this Deal</h3>
                <div style="font-size:var(--fs-base);color:var(--text-secondary);">
                    <div><b>Owner:</b> @Model.Deal.Owner?.FirstName @Model.Deal.Owner?.LastName</div>
                    <div><b>Company:</b> @Model.Deal.Company?.Name</div>
                    <div><b>Close Date:</b> @Model.Deal.CloseDate?.ToString("MM/dd/yyyy")</div>
                    <div><b>Created At:</b> @Model.Deal.CreatedAt.ToString("MM/dd/yyyy hh:mm tt")</div>
                </div>
            </section>
        </aside>

        <main style="flex: 2; min-width: 520px;">
            <nav class="nav-tabs" style="display:flex; gap:var(--space-md); border-bottom:1px solid var(--border-color); margin-bottom: var(--space-lg);">
                <button type="button" class="nav-box active" id="tab-overview" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('overview')">Overview</button>
                <button type="button" class="nav-box" id="tab-activities" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('activities')">Activities</button>
            </nav>

            <section id="tab-content-overview" class="tab-content" style="display:block;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Data Highlights</h3>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-lg);color:var(--text-secondary);">
                        <div>
                            <b>Deal Name:</b><br /> @Model.Deal.Name
                        </div>
                        <div>
                            <b>Value:</b><br /> @Model.Deal.Value?.ToString("C0")
                        </div>
                        <div>
                            <b>Stage:</b><br /> @Model.Deal.Stage?.Name
                        </div>
                        <div>
                            <b>Close Date:</b><br /> @Model.Deal.CloseDate?.ToString("MM/dd/yyyy")
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-content-activities" class="tab-content" style="display:none;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Recent Activities</h3>
                    @if (Model.Activities != null && Model.Activities.Any())
                    {
                        <ul style="list-style:none;padding:0;margin:0; max-height: 300px; overflow-y: auto;">
                            @foreach (var act in Model.Activities.OrderByDescending(a => a.ActivityDate))
                            {
                                var icon = act.ActivityType?.Name.ToLower() ?? "tasks";
                                var activityName = act.ActivityType?.Name ?? "Activity";

                                if (activityName.Equals("Email", StringComparison.OrdinalIgnoreCase))
                                {
                                    icon = "envelope";
                                }
                                else if (activityName.Equals("Call", StringComparison.OrdinalIgnoreCase))
                                {
                                    icon = "phone";
                                }
                                else if (activityName.Equals("Task", StringComparison.OrdinalIgnoreCase))
                                {
                                    // Use the singular "task" icon
                                    icon = "tasks";
                                }

                                string onClickHandler = "";
                                string liStyle = "border-bottom:1px solid var(--border-color); padding:var(--space-md) 0; display:flex; gap: var(--space-md); align-items: flex-start;";

                                // Safer check for "Task"
                                bool isTask = (activityName ?? "").Equals("Task", StringComparison.OrdinalIgnoreCase);

                                if (isTask )
                                {
                                    onClickHandler = $"openUpdateTaskModal({act.SubjectId})";
                                    liStyle += " cursor:pointer;";
                                }

                                <li style="@liStyle" onclick="@onClickHandler">
                                    <div style="font-size: 1.25rem; color: var(--color-primary); margin-top: 3px;">
                                        <i class="fas fa-@icon"></i>
                                    </div>

                                    <div style="flex-grow: 1;">
                                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                            <h6 style="font-weight:var(--fw-bold); color: var(--color-accent1); margin: 0;">
                                                @activityName
                                            </h6>
                                            <span style="color:var(--text-secondary); font-size: var(--fs-sm);">
                                                @act.ActivityDate.ToString("dd MMM yyyy")
                                            </span>
                                        </div>

                                        <div style="color:var(--text-secondary); font-size: 0.95rem;">
                                            @act.Notes
                                        </div>

                                        @if (isTask && act.DueDate.HasValue)
                                        {
                                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                                <span style="font-weight: 500;">Due: @act.DueDate.Value.ToString("dd MMM yyyy")</span>
                                                - <span style="color: var(--color-accent);">Status: @act.Status</span>
                                            </div>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p style="color:var(--text-tertiary);">No recent activities for this deal.</p>
                    }
                </div>
            </section>
        </main>

        <aside style="flex:1; min-width: 280px;">
            <section style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Company</h3>
                    @if (Model.Deal.Company == null)
                    {
                        <div style="display:flex; gap: 5px;">
                            <button class="btn btn-custom" type="button"
                                    style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);"
                                    onclick="openCompanyModal()">
                                + Add
                            </button>
                        </div>
                    }
                </div>
                @if (Model.Deal.Company != null)
                {
                    @* <div style="background:var(--bg-primary);border-radius:var(--border-radius-sm);padding:var(--space-md);box-shadow:var(--shadow-sm);margin-bottom:var(--space-sm);">
                        <div style="font-weight:var(--fw-bold);margin-bottom:var(--space-xs);">@Model.Deal.Company.Name</div>
                        <span style="color:var(--text-secondary);font-size:var(--fs-sm);">Domain: @Model.Deal.Company.Domain</span>
                    </div> *@
                    <div style="background:var(--bg-primary);border-radius:var(--border-radius-sm);padding:var(--space-md);box-shadow:var(--shadow-sm);margin-bottom:var(--space-sm); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:var(--fw-bold);margin-bottom:var(--space-xs);">@Model.Deal.Company.Name</div>
                            <span style="color:var(--text-secondary);font-size:var(--fs-sm);">Domain: @Model.Deal.Company.Domain</span>
                        </div>
                        <button class="btn-hover-shadow"
                                title="Disassociate Company"
                                onclick="removeCompanyFromDeal(@Model.Deal.Id)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                }
                else
                {
                    <p style="color:var(--text-tertiary);">No company associated.</p>
                }
            </section>
            <section style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Contacts</h3>
                    <div style="display:flex; gap: 5px;">
                        <button class="btn btn-custom" type="button"
                                style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);"
                                onclick="openContactModal()">
                            + Add
                        </button>
                    </div>
                </div>

                @if (Model.Contacts != null && Model.Contacts.Any())
                {
                    foreach (var contact in Model.Contacts)
                    {
                        <div style="background:var(--bg-primary);border-radius:var(--border-radius-sm);padding:var(--space-md);box-shadow:var(--shadow-sm);margin-bottom:var(--space-sm); display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <a href="@Url.Action("Preview", "Contact", new { id = contact.Id })"
                                   style="font-weight:var(--fw-bold);margin-bottom:var(--space-xs); text-decoration:none;">
                                    @contact.FirstName @contact.LastName
                                </a>
                                <div style="color:var(--text-secondary);font-size:var(--fs-sm);">@contact.Email</div>
                            </div>

                            <button class="btn-hover-shadow"
                                    title="Remove Contact"
                                    onclick="removeContactFromDeal(@contact.Id, @Model.Deal.Id)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    }
                }
                else
                {
                    <p style="color:var(--text-tertiary);">No contacts associated with this deal.</p>
                }
            </section>

            @* <section style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Contacts</h3>
                    <div style="display:flex; gap: 5px;">
                        <button class="btn btn-custom" type="button"
                                style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);"
                                onclick="openContactModal()">
                            + Add
                        </button>
                    </div>
                </div>
                @if (Model.Contacts != null && Model.Contacts.Any())
                {
                    @foreach (var contact in Model.Contacts)
                    {
                        <div style="background:var(--bg-primary);border-radius:var(--border-radius-sm);padding:var(--space-md);box-shadow:var(--shadow-sm);margin-bottom:var(--space-sm);">
                            <a href="@Url.Action("Preview", "Contact", new { id = contact.Id })" style="font-weight:var(--fw-bold);margin-bottom:var(--space-xs); text-decoration:none;">
                                @contact.FirstName @contact.LastName
                            </a>
                            <div style="color:var(--text-secondary);font-size:var(--fs-sm);">@contact.Email</div>
                        </div>
                    }
                }
                else
                {
                    <p style="color:var(--text-tertiary);">No contacts associated with this deal.</p>
                }
            </section> *@
        </aside>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
@Html.AntiForgeryToken() @* Add token for AJAX POST *@

<script>
    function showTab(tabName) {
        document.getElementById('tab-content-overview').style.display = 'none';
        document.getElementById('tab-content-activities').style.display = 'none';

        document.getElementById('tab-overview').classList.remove('active');
        document.getElementById('tab-activities').classList.remove('active');

        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('tab-content-' + tabName).style.display = 'block';
    }

    // --- Contact Modal Functions ---
    function openContactModal() {
        // Get the Company ID from the model.
        // Razor will render this as 'var companyId = 123;' or 'var companyId = null;'
        var companyId = @(Model.Deal.Company?.Id.ToString() ?? "null");
        var url = '@Url.Action("GetAllContactsForCompany", "Contact")';

        // Prepare the data for the AJAX request
        var requestData = {};

        // IMPORTANT: Only add the companyId to the request if it exists
        if (companyId) {
            requestData.companyId = companyId;
        }

        // Pass the requestData object to $.get.
        // jQuery will automatically append it as a query string (e.g., ?companyId=123)
        $.get(url, requestData, function (response) {
            var list = $('#contactList');
            list.empty();
            if (response.data && response.data.length > 0) {
                response.data.forEach(function (contact) {
                    list.append(
                        `<li style="padding:8px; border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="selectContact(${contact.id})">
                            <b>${contact.name ?? 'Unnamed Contact'}</b>
                            <span style="color:var(--text-secondary); font-size:var(--fs-sm); display:block;">${contact.email ?? ''}</span>
                        </li>`
                    );
                });
            } else {
                list.append('<li>No contacts found for this company.</li>');
            }
            $('#contactModal').css('display', 'flex');
        });
    }

        function removeContactFromDeal(contactId, dealId) {
        if (!confirm("Are you sure you want to remove this contact from the deal?")) {
            return;
        }

        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("DisassociateContactFromDeal", "Contact")',
            type: 'POST',
            data: {
                contactId: contactId,
                dealId: dealId
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function (response) {
                alert(response.message || "Contact removed successfully!");
                location.reload();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON?.message || xhr.responseText || "Failed to remove contact.";
                alert("Error: " + msg);
            }
        });
    }


    function closeContactModal() {
        $('#contactModal').hide();
    }

    function selectContact(contactId) {
        var dealId = @Model.Deal.Id;
        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("AssociateContactToDeal", "Contact")',
            type: 'POST',
            data: {
                contactId: contactId,
                dealId: dealId
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function () {
                closeContactModal();
                location.reload();
            },
            error: function(xhr) {
                alert("Failed to associate contact: " + (xhr.responseJSON?.message || xhr.responseText));
            }
        });
    }

    // --- Task Modal Functions ---
    $('#taskModalContainer').on('submit', '#createTaskForm', function (event) {
        event.preventDefault();
        var form = $(this);
        if ($.validator && $.validator.unobtrusive && !form.valid()) {
            return false;
        }
        $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: form.serialize(),
            success: function (response) {
                closeCreateTaskModal();
                alert(response.message || "Task created successfully!");
                location.reload();
            },
            error: function (xhr) {
                var response = xhr.responseJSON;
                if (response && response.errors) {
                    var errorMsg = "Validation failed:\n" + response.errors.join("\n");
                    alert(errorMsg);
                } else {
                    alert("An error occurred: " + (xhr.responseJSON?.message || xhr.responseText));
                }
            }
        });
    });

    // 2. Open Create Task Modal
    function openCreateTaskModal(contactId, dealId) { 
        var url = '@Url.Action("Create", "Task")' +
                    '?contactId=' + (contactId || '') +
                    '&dealId=' + (dealId || '');     

        $.get(url, function (data) {
            $('#taskModalContainer').html(data);
            $('#createTaskModal').css('display', 'flex');

            var form = $("#createTaskForm");
            if ($.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse(form);
            }
        })
        .fail(function(xhr) {
             alert("Error loading task modal: " + (xhr.responseJSON?.message || "Server error. Check logs."));
        });
    }

    // 3. Close Create Task Modal
    function closeCreateTaskModal() {
        $('#taskModalContainer').html('');
    }

    // --- NEW: Update Task Functions ---

    // 4. Update Task Submit Handler
    $('#taskUpdateModalContainer').on('submit', '#updateTaskForm', function (event) {
        event.preventDefault();
        var form = $(this);
        if ($.validator && $.validator.unobtrusive && !form.valid()) {
            return false;
        }
        $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: form.serialize(),
            success: function (response) {
                closeUpdateTaskModal();
                alert(response.message || "Task updated successfully!");
                location.reload();
            },
            error: function (xhr) {
                var response = xhr.responseJSON;
                if (response && response.errors) {
                    var errorMsg = "Update failed:\n" + response.errors.join("\n");
                    alert(errorMsg);
                } else {
                    alert("An error occurred: " + (xhr.responseJSON?.message || xhr.responseText));
                }
            }
        });
    });

    // 5. Open Update Task Modal
    function openUpdateTaskModal(taskId) {
        var url = '@Url.Action("Update", "Task")' + '?taskId=' + taskId;

        $.get(url, function (data) {
            $('#taskUpdateModalContainer').html(data);
            $('#updateTaskModal').css('display', 'flex');

            var form = $("#updateTaskForm");
            if ($.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse(form);
            }
        })
        .fail(function(xhr) {
             alert("Error loading task for update: " + (xhr.responseJSON?.message || "Server error."));
        });
    }

    // 6. Close Update Task Modal
    function closeUpdateTaskModal() {
        $('#taskUpdateModalContainer').html('');
    }



    function deleteDeal(dealId) {
        if (!confirm("Are you sure you want to delete this deal? This action cannot be undone.")) {
            return;
        }

        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("Delete", "Deal")', // This controller action needs to be added
            type: 'POST',
            data: {
                id: dealId
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function (response) {
                alert(response.message || "Deal deleted successfully!");
                // Redirect to the main deals board
                window.location.href = '@Url.Action("KanbanBoard", "Deal")';
            },
            error: function (xhr) {
                var msg = xhr.responseJSON?.message || xhr.responseText || "Failed to delete the deal.";
                alert("Error: " + msg);
            }
        });
    }



    function openCompanyModal() {
        // NOTE: This assumes you have a 'CompanyController' with a 'GetAllCompanies' action
        // that returns JSON like { data: [ { id: 1, name: "Acme Inc.", domain: "acme.com" } ] }
        var url = '@Url.Action("GetAll", "Company")';

        $.get(url, function (response) {
            var list = $('#companyList');
            list.empty();
            if (response.data && response.data.length > 0) {
                response.data.forEach(function (company) {
                    list.append(
                        `<li style="padding:8px; border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="selectCompany(${company.id})">
                            <b>${company.name ?? 'Unnamed Company'}</b>
                            <span style="color:var(--text-secondary); font-size:var(--fs-sm); display:block;">${company.domain ?? ''}</span>
                        </li>`
                    );
                });
            } else {
                list.append('<li>No companies found.</li>');
            }
            $('#companyModal').css('display', 'flex');
        }).fail(function() {
            alert("Error: Could not load company list. Ensure 'CompanyController' and 'GetAllCompanies' action exist.");
        });
    }

    function closeCompanyModal() {
        $('#companyModal').hide();
    }

    function selectCompany(companyId) {
        var dealId = @Model.Deal.Id;
        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("AssociateCompanyToDeal", "Deal")', // Action to be added to DealController
            type: 'POST',
            data: {
                companyId: companyId,
                dealId: dealId
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function () {
                closeCompanyModal();
                location.reload();
            },
            error: function(xhr) {
                alert("Failed to associate company: " + (xhr.responseJSON?.message || xhr.responseText));
            }
        });
    }

    function removeCompanyFromDeal(dealId) {
        if (!confirm("Are you sure you want to disassociate this company from the deal?")) {
            return;
        }

        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("DisassociateCompanyFromDeal", "Deal")', // Action to be added to DealController
            type: 'POST',
            data: {
                dealId: dealId
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function (response) {
                alert(response.message || "Company removed successfully!");
                location.reload();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON?.message || xhr.responseText || "Failed to remove company.";
                alert("Error: " + msg);
            }
        });
    }

</script>