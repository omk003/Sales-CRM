@model scrm_dev_mvc.Models.ViewModels.ContactPreviewViewModel
<style>
    .btn-hover-shadow:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
    <div style="padding: 0 0 0 var(--space-md);">
        <a href="@Url.Action("Index", "Contact")" style="
        display: inline-block;
        color: var(--color-primary);
        font-size: var(--fs-sm);
        font-family: var(--font-primary);
        font-weight: var(--fw-bold);
        text-decoration: none;
        letter-spacing: 0.03em;
        transition: var(--transition-base);
        border-radius: var(--border-radius-sm);
        
        
    "
           onmouseover="this.style.backgroundColor=window.getComputedStyle(document.body).getPropertyValue('--bg-secondary')"
           onmouseout="this.style.backgroundColor='transparent'">
            &lt; Contacts
        </a>
    </div>
<!-- Email Compose Modal -->
<div id="emailModal" class="modal" tabindex="-1" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 450px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Send Email</h5>
                <button type="button" class="btn-close" onclick="closeEmailModal()"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm" autocomplete="off">
                    <div style="margin-bottom:var(--space-md);">
                        <label for="emailSubject" style="font-weight:var(--fw-bold);">Subject</label>
                        <input type="text" id="emailSubject" name="subject" style="width:100%;padding:var(--space-sm);border-radius:var(--border-radius-sm);border:1px solid var(--border-color);" required />
                    </div>
                    <div style="margin-bottom:var(--space-md);">
                        <label for="emailBody" style="font-weight:var(--fw-bold);">Body</label>
                        <textarea id="emailBody" name="body" rows="6" style="width:100%;padding:var(--space-sm);border-radius:var(--border-radius-sm);border:1px solid var(--border-color);" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-custom" style="width:100%;">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>
    <!-- Company Select Modal -->
    <!-- Modal ... -->
<div id="companyModal" class="modal" tabindex="-1" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 400px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Select a Company</h5>
                <button type="button" class="btn-close" onclick="closeCompanyModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 350px; overflow-y: auto;">
                <ul id="companyList" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Call Contact Modal -->
<div id="callModal" class="modal" tabindex="-1"
     style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 350px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Call Contact</h5>
                <button type="button" class="btn-close" onclick="closeCallModal()"></button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:var(--space-md);">
                    <label style="font-weight:var(--fw-bold);">Contact Number</label>
                    <div style="padding:var(--space-sm);font-size:var(--fs-base);background:var(--bg-secondary);border-radius:var(--border-radius-sm);border:1px solid var(--border-color);">
                        @Model.PhoneNumber
                    </div>
                </div>
                <button type="button" class="btn btn-custom" style="width:100%;" onclick="makeCall()">
                    Call
                </button>
            </div>
        </div>
    </div>
</div>
<div id="taskModalContainer">
</div>
<div id="taskUpdateModalContainer"></div>
<!-- Deal Select Modal -->
<div id="dealModal" class="modal" tabindex="-1" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-dialog" style="max-width: 400px; margin: 4rem auto;">
        <div class="modal-content" style="background:var(--bg-primary);border-radius:var(--border-radius-lg);padding:var(--space-lg);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Select a Deal</h5>
                <button type="button" class="btn-close" onclick="closeDealModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 350px; overflow-y: auto;">
                <ul id="dealList" style="list-style:none;padding:0;margin:0;">
                    <!-- Deals will be loaded here by JavaScript -->
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" style="max-width: var(--container-width); margin: var(--space-xl) auto;">
    <div class="row" style="display: flex; gap: var(--space-lg);">

        <!-- Column 1: Contact Profile & Actions -->
        <aside style="flex: 1; min-width: 280px;">
                <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); padding: var(--space-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--space-lg); text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <span class="rounded-circle" style="display:inline-block;width:80px;height:80px;background:var(--color-accent2);color:var(--color-secondary);text-align:center;line-height:80px; font-size: 2.5rem;">
                            <i class="fas fa-user"></i>
                        </span>
                        <h2 style="font-size: var(--fs-h3); margin: 0;">@Model.Name</h2>
                    </div>
                    <p style="color: var(--color-accent1); margin-bottom: var(--space-sm);">@Model.JobTitle</p>
                    <p style="color: var(--text-secondary);">@Model.Email</p>
                    <div style="display:flex; justify-content:center; gap:var(--space-md); margin-bottom: var(--space-md);">
                    <a href="javascript:void(0);" title="Email" style="color: var(--color-secondary);" onclick="openEmailModal()">
                        <i class="fas fa-envelope"></i>
                    </a>
                    <a href="javascript:void(0);" title="Call" style="color: var(--color-accent);" onclick="openCallModal()">
                        <i class="fas fa-phone"></i>
                    </a>
                    <a href="javascript:void(0);"
                       title="Task"
                       style="color: var(--color-primary);"
                       onclick="openCreateTaskModal(@Model.Id, null, null)">
                        <i class="fas fa-tasks"></i>
                    </a>
                    </div>
                </section>
            <section style="background: var(--bg-secondary); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); padding: var(--space-lg);">
                <h3 style="font-size: var(--fs-lg); color: var(--color-accent1); margin-bottom: var(--space-md);">About this contact</h3>
                <div style="font-size:var(--fs-base);color:var(--text-secondary);">
                    <div><b>Email:</b> @Model.Email</div>
                    <div><b>Phone:</b> @Model.PhoneNumber</div>
                    <div><b>Created At:</b> @Model.CreatedAt?.ToString("MM/dd/yyyy hh:mm tt")</div>
                </div>
            </section>
        </aside>

        <!-- Column 2: Tabs and Overview/Activities -->
        <main style="flex: 2; min-width: 520px;">
            <nav class="nav-tabs" style="display:flex; gap:var(--space-md); border-bottom:1px solid var(--border-color); margin-bottom: var(--space-lg);">
                <button type="button" class="nav-box active" id="tab-overview" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('overview')">Overview</button>
                <button type="button" class="nav-box" id="tab-activities" style="background:none;border:none;padding:var(--space-sm) var(--space-md);font-size:var(--fs-lg);color:var(--color-accent1);" onclick="showTab('activities')">Activities</button>
                
            </nav>
            <section id="tab-content-overview" class="tab-content" style="display:block;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Data Highlights</h3>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-lg);color:var(--text-secondary);">
                        <div>
                            <b>Create Date:</b><br />@Model.CreatedAt?.ToString("MM/dd/yyyy hh:mm tt")
                        </div>
                        <div>
                            <b>Last Activity Date:</b><br />@Model.LastActivityDate.ToString("MM/dd/yyyy hh:mm tt")
                        </div>
                        <div>
                            <b>Lifecycle Stage:</b><br />@Model.LifecycleStage
                        </div>
                        <div>
                            <b>Lead Status:</b><br />@Model.LeadStatus
                        </div>
                    </div>
                </div>
                
            </section>
            <section id="tab-content-activities" class="tab-content" style="display:none;">
                <div style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Recent Activities</h3>
                    <div style="margin-bottom:var(--space-md);">
                        <input type="text" style="width:70%;padding:var(--space-sm);border-radius:var(--border-radius-sm);border:1px solid var(--border-color);" placeholder="Search activities" />
                        <button class="btn btn-custom" style="margin-left:var(--space-sm);">Search</button>
                    </div>
                    
                    @if (Model.Activities != null && Model.Activities.Any())
                    {

                        <ul style="list-style:none;padding:0;margin:0; max-height: 300px; overflow-y: auto;">
                            @foreach (var act in Model.Activities.OrderByDescending(a => a.ActivityDate))
                            {
                                var activityName = act.ActivityType?.Name ?? "Activity";
                                var icon = "tasks";
                                if (activityName.Equals("Email", StringComparison.OrdinalIgnoreCase)) { icon = "envelope"; }
                                else if (activityName.Equals("Call", StringComparison.OrdinalIgnoreCase)) { icon = "phone"; }
                                
                                // --- START OF LOGIC ---
                                string onClickHandler = "";
                                string liStyle = "border-bottom:1px solid var(--border-color); padding:var(--space-md) 0; display:flex; gap: var(--space-md); align-items: flex-start;";

                                // Check if it's a task and has a SubjectId to link to
                                if (activityName == "Task" && act.SubjectId.HasValue)
                                {
                                    onClickHandler = $"openUpdateTaskModal({act.SubjectId.Value})";
                                    liStyle += " cursor:pointer;"; // Make it look clickable
                                }
                                // --- END OF LOGIC ---

                                <li style="@liStyle" onclick="@onClickHandler">

                                    <div style="font-size: 1.25rem; color: var(--color-primary); margin-top: 3px;">
                                        <i class="fas fa-@icon"></i>
                                    </div>

                                    <div style="flex-grow: 1;">

                                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                            <h6 style="font-weight:var(--fw-bold); color: var(--color-accent1); margin: 0;">
                                                @activityName
                                            </h6>
                                            <span style="color:var(--text-secondary); font-size: var(--fs-sm);">
                                                @act.ActivityDate?.ToString("dd MMM yyyy")
                                            </span>
                                        </div>

                                        <div style="color:var(--text-secondary); font-size: 0.95rem;">
                                            @act.Notes
                                        </div>

                                        @if (act.ActivityType?.Name == "Task" && act.DueDate.HasValue)
                                        {
                                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                                <span style="font-weight: 500;">Due: @act.DueDate.Value.ToString("dd MMM yyyy")</span>
                                                - <span style="color: var(--color-accent);">Status: @act.Status</span>
                                            </div>
                                        }

                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p style="color:var(--text-tertiary);">No recent activities.</p>
                    }
                </div>
            </section>
           
        </main>

        <!-- Column 3: Company & Deals -->
        <aside style="flex:1; min-width: 280px;">
            <section style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);margin-bottom:var(--space-lg);">

                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Company</h3>

                    @if (Model.Company == null || Model.Company.Id <= 0)
                    {
                        <button class="btn btn-custom" type="button" onclick="openCompanyModal()">+ Add</button>
                    }
                </div>

                @if (Model.Company != null && Model.Company.Id > 0)
                {
                    <div style="background:var(--bg-primary);
                                padding:var(--space-md);
                                box-shadow:var(--shadow-sm);
                                margin-bottom:var(--space-sm);">

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-xs);">
                            <!-- Left section: Name + Domain in same line -->
                            <div style="display:flex; align-items:center; gap:var(--space-sm);">
                                <div style="font-weight:var(--fw-bold);">
                                    @Model.Company.Name
                                </div>
                                <span style="color:var(--text-secondary); font-size:var(--fs-sm); padding-left:5px;">
                                    Domain: @Model.Company.Domain
                                </span>
                            </div>

                            <!-- Right section: Delete button -->
                            <button class="btn-hover-shadow"
                                    type="button"
                                    title="Disassociate Company"
                                    onclick="disassociateCompany()"
                                    style="font-size:var(--fs-sm);
                           padding:var(--space-xs) var(--space-sm);
                           background:white;
                           color:black;
                           border-radius:var(--border-radius-sm);
                           cursor:pointer;
                           transition:box-shadow 0.3s ease;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>

                    

                }
                else
                {
                    <p style="color:var(--text-tertiary);">No company associated.</p>
                }
            </section>

            <section style="background:var(--bg-secondary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-sm);padding:var(--space-lg);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:var(--fs-lg);color:var(--color-accent1);margin-bottom:var(--space-md);">Deals</h3>
                    @* <button class="btn btn-custom" type="button"
                            style="font-size:var(--fs-sm);padding:var(--space-xs) var(--space-sm);"
                            onclick="openDealModal()">
                        + Add
                    </button> *@
                </div>
                @if (Model.Deals != null && Model.Deals.Any())
                {
                    @foreach (var deal in Model.Deals)
                    {
                        <div style="background:var(--bg-primary);border-radius:var(--border-radius-sm);padding:var(--space-md);box-shadow:var(--shadow-sm);margin-bottom:var(--space-sm);">
                            <div style="font-weight:var(--fw-bold);margin-bottom:var(--space-xs);">
                                <a href="@Url.Action("Details", "Deal", new { id = deal.Id })" style="text-decoration:none;">
                                    @deal.Name
                                </a>
                            </div>
                            <span style="color:var(--text-secondary);font-size:var(--fs-sm);">
                                @deal.Value?.ToString("C0")
                            </span>
                            <span style="color:var(--text-secondary);font-size:var(--fs-sm); display:block;">
                                Created: @deal.CreatedAt?.ToString("MM/dd/yyyy")
                            </span>
                        </div>
                    }
                }
                else
                {
                    <p style="color:var(--text-tertiary);">No deals associated.</p>
                }
            </section>
        </aside>
    </div>
</div>

<!-- FontAwesome for icons (if not already included) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
@Html.AntiForgeryToken()


<script>
    $('#taskUpdateModalContainer').on('submit', '#updateTaskForm', function (event) {
    event.preventDefault(); 
    var form = $(this);
    if ($.validator && $.validator.unobtrusive && !form.valid()) {
        return false;
    }

    $.ajax({
        url: form.attr('action'),
        type: form.attr('method'),
        data: form.serialize(),
        success: function (response) {
            closeUpdateTaskModal();
            alert(response.message || "Task updated successfully!");
            location.reload(); 
        },
        error: function (xhr) {
            var response = xhr.responseJSON;
            if (response && response.errors) {
                var errorMsg = "Update failed:\n" + response.errors.join("\n");
                alert(errorMsg);
            } else {
                alert("An error occurred: " + (xhr.responseJSON?.message || xhr.responseText));
            }
        }
    });
});

// --- NEW FUNCTION TO OPEN THE UPDATE MODAL ---
function openUpdateTaskModal(taskId) {
    var url = '@Url.Action("Update", "Task")' + '?taskId=' + taskId;
    
    $.get(url, function (data) {
        $('#taskUpdateModalContainer').html(data);
        
        // This modal ID is 'updateTaskModal'
        $('#updateTaskModal').css('display', 'flex'); 
        
        var form = $("#updateTaskForm");
        if ($.validator && $.validator.unobtrusive) {
            $.validator.unobtrusive.parse(form);
        }
    })
    .fail(function(xhr) { 
         alert("Error loading task for update: " + (xhr.responseJSON?.message || "Server error."));
    });
}

// --- NEW FUNCTION TO CLOSE THE UPDATE MODAL ---
function closeUpdateTaskModal() {
    $('#taskUpdateModalContainer').html(''); 
}


       $('#taskModalContainer').on('submit', '#createTaskForm', function (event) {
        // This will now correctly stop the default form submission
        event.preventDefault(); 

        var form = $(this);

        // Check if validation scripts are loaded and if form is valid
        // This check prevents errors if validation scripts are missing
        if ($.validator && $.validator.unobtrusive && !form.valid()) {
            return false;
        }

        $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: form.serialize(),
            success: function (response) {
                closeCreateTaskModal();
                alert(response.message || "Task created successfully!");
                location.reload(); // Reloads the original page
            },
            error: function (xhr) {
                var response = xhr.responseJSON;
                if (response && response.errors) {
                    var errorMsg = "Validation failed:\n" + response.errors.join("\n");
                    alert(errorMsg);
                } else {
                    alert("An error occurred while creating the task.");
                }
            }
        });
    });

    function openCreateTaskModal(contactId, companyId, dealId) {
        var url = '@Url.Action("Create", "Task")' +
                    '?contactId=' + (contactId || '') +
                    '&companyId=' + (companyId || '') +
                    '&dealId=' + (dealId || '');

        // 1. Load the partial view from the controller
        $.get(url, function (data) {
            // 2. Inject the HTML into our placeholder
            $('#taskModalContainer').html(data);

            // 3. Show the modal
            $('#createTaskModal').css('display', 'flex');

            // 4. We still need to parse validation for the new dynamic content
            var form = $("#createTaskForm");
            if ($.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse(form);
            }

            // 5. REMOVED: We no longer call handleTaskFormSubmit() here.
        });
    }

    function closeCreateTaskModal() {
        $('#taskModalContainer').html(''); // Clear the HTML
    }

    function showTab(tabName) {
        document.getElementById('tab-content-overview').style.display = 'none';
        document.getElementById('tab-content-activities').style.display = 'none';

        document.getElementById('tab-' + tabName).classList.add('active');
        ['overview', 'activities'].forEach(function(tab) {
            if (tab !== tabName) document.getElementById('tab-' + tab).classList.remove('active');
        });
        document.getElementById('tab-content-' + tabName).style.display = 'block';
    }
        function closeCompanyModal() {
                document.getElementById('companyModal').style.display = 'none';
            }
        function openCompanyModal() {
            // Fetch companies from server
            $.get('/Company/GetAll', function (response) {
            var list = $('#companyList');
            list.empty();

            // Use response.data (array)
            response.data.forEach(function (company) {
                list.append(
                    `<li style="padding:8px; border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="selectCompany(${company.id})">
                        <b>${company.name ?? 'Unnamed Company'}</b>
                        <span style="color:var(--text-secondary); font-size:var(--fs-sm);">${company.domain ?? ''}</span>
                    </li>`
                );
            });
            $('#companyModal').css('display', 'flex');
        });
        }

        function closeCompanyModal() {
            $('#companyModal').hide();
        }

        // --- THIS IS THE UPDATED FUNCTION ---
        function selectCompany(companyId) {
            // Get the AntiForgeryToken
            var token = $('input[name="__RequestVerificationToken"]').val();

            // POST selected companyId and contactId to server
            $.ajax({
                url: '/Contact/AssociateContactToCompany',
                type: 'POST',
                data: { contactId: '@Model.Id', companyId: companyId },
                headers: {
                    "RequestVerificationToken": token // <-- ADDED TOKEN
                },
                success: function (response) { // <-- Added 'response'
                    closeCompanyModal();
                    alert(response.message || "Company associated successfully!"); // Show success message
                    location.reload();
                },
                error: function(xhr) { // <-- ADDED ERROR HANDLER
                    // Show the error message from your controller
                    alert("Failed to associate company: " + (xhr.responseJSON?.message || xhr.responseText));
                }
            });
        }

        function openEmailModal() {
        // Reset form fields
        $('#emailSubject').val('');
        $('#emailBody').val('');
        $('#emailModal').css('display', 'flex');
    }
    function closeEmailModal() {
        $('#emailModal').hide();
    }

    // Handle form submit
    $('#emailForm').on('submit', function(event){
        event.preventDefault();
        var subject = $('#emailSubject').val();
        var body = $('#emailBody').val();
        var contactEmail = '@Model.Email';

        $.ajax({
            url: '/Contact/SendEmail',
            type: 'POST',
            data: { contactEmail: contactEmail, subject: subject, body: body },
            success: function(response) {
                closeEmailModal();
                alert("Email sent successfully!");
            },
            error: function() {
                alert("Failed to send email.");
            }
        });
    });

        function openCallModal() {
        $('#callModal').css('display', 'flex');
    }
    function closeCallModal() {
        $('#callModal').hide();
    }
    function makeCall() {
        var phoneNumber = '@Model.PhoneNumber';
        var contactId = '@Model.Id';
        $.ajax({
            url: '/Contact/CallContact',
            type: 'POST',
            data: { phoneNumber: phoneNumber, contactId: contactId },
            success: function(response) {
                closeCallModal();
                alert("Call initiated! (SID: " + response + ")");
            },
            error: function() {
                alert("Failed to initiate call.");
            }
        });
    }

    function openDealModal() {
        // Fetch all deals from the server
        $.get('@Url.Action("GetAll", "Deal")', function (response) { // Assuming you have a /Deal/GetAll endpoint
            var list = $('#dealList');
            list.empty();

            if (response.data && response.data.length > 0) {
                response.data.forEach(function (deal) {
                    // Generate a formatted value, or "No Value"
                    var dealValue = deal.value ?
                        new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(deal.value) :
                        'No Value';

                    list.append(
                        `<li style="padding:8px; border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="selectDeal(${deal.id})">
                            <b>${deal.name ?? 'Unnamed Deal'}</b>
                            <span style="color:var(--text-secondary); font-size:var(--fs-sm); display:block;">${dealValue}</span>
                        </li>`
                    );
                });
            } else {
                list.append('<li>No deals found.</li>');
            }
            $('#dealModal').css('display', 'flex');
        });
    }

    function closeDealModal() {
        $('#dealModal').hide();
    }

    function selectDeal(dealId) {
        // Get the current Contact ID from the model
        var contactId = @Model.Id;

        // Get the AntiForgeryToken
        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '@Url.Action("AssociateContactToDeal", "Contact")', // Action we created
            type: 'POST',
            data: {
                contactId: contactId,
                dealId: dealId
            },
            headers: {
                "RequestVerificationToken": token // Send the token
            },
            success: function () {
                closeDealModal();
                location.reload(); // Reload the page to show the new association
            },
            error: function(xhr) {
                alert("Failed to associate deal: " + xhr.responseText);
            }
        });
    }
    function disassociateCompany() {
        // Get the AntiForgeryToken
        var token = $('input[name="__RequestVerificationToken"]').val();

        if (!confirm("Are you sure you want to remove this company from the contact?")) {
            return;
        }

        $.ajax({
            url: '@Url.Action("DisassociateCompany", "Contact")', // New controller action
            type: 'POST',
            data: {
                contactId: '@Model.Id'
            },
            headers: {
                "RequestVerificationToken": token
            },
            success: function (response) {
                alert(response.message || "Company removed successfully!");
                location.reload();
            },
            error: function(xhr) {
                alert("Failed to remove company: " + (xhr.responseJSON?.message || xhr.responseText));
            }
        });
    }
</script>
